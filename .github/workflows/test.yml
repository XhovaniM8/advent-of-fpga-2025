name: Test All Designs

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  test-verilog:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y verilator iverilog
      
      - name: Compile and lint Verilog/SystemVerilog
        run: |
          echo "## Verilog/SystemVerilog Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Compile | Lint |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|------|" >> $GITHUB_STEP_SUMMARY
          
          shopt -s nullglob
          for file in designs/*.sv designs/*.v; do
            echo "Testing $file"
            
            if verilator --lint-only "$file" 2>&1 | tee compile.log; then
              COMPILE="PASS"
            else
              COMPILE="FAIL"
            fi
            
            if verilator --lint-only -Wall -Wno-DECLFILENAME "$file" 2>&1 | grep -qi "error"; then
              LINT="ERROR"
            elif grep -qi "warning" compile.log; then
              LINT="WARN"
            else
              LINT="CLEAN"
            fi
            
            echo "| \`$(basename $file)\` | $COMPILE | $LINT |" >> $GITHUB_STEP_SUMMARY
          done

  test-hardcaml:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for Hardcaml files
        id: check
        run: |
          if ls designs/*.ml 2>/dev/null; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up OCaml
        if: steps.check.outputs.found == 'true'
        uses: ocaml/setup-ocaml@v2
        with:
          ocaml-compiler: 4.13.x
      
      - name: Add Jane Street opam repos
        if: steps.check.outputs.found == 'true'
        run: |
          opam repo add janestreet-bleeding https://ocaml.janestreet.com/opam-repository
          opam repo add janestreet-bleeding-external https://github.com/janestreet/opam-repository.git\#external-packages
          opam update
      
      - name: Install Hardcaml
        if: steps.check.outputs.found == 'true'
        run: |
          opam install hardcaml -y
      
      - name: Test Hardcaml files
        if: steps.check.outputs.found == 'true'
        run: |
          echo "## Hardcaml Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for file in designs/*.ml; do
            echo "Testing $file"
            if opam exec -- ocamlfind ocamlc -package hardcaml -c "$file" 2>&1; then
              echo "- PASS: \`$(basename $file)\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "- FAIL: \`$(basename $file)\`" >> $GITHUB_STEP_SUMMARY
            fi
          done

  run-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for test files
        id: check
        run: |
          if ls tests/*.py 2>/dev/null; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi
      
      - uses: actions/setup-python@v5
        if: steps.check.outputs.found == 'true'
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        if: steps.check.outputs.found == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y iverilog verilator
          pip install cocotb pytest
      
      - name: Run functional tests
        if: steps.check.outputs.found == 'true'
        run: |
          cd tests
          pytest -v . || true
          
          echo "## Functional Tests" >> $GITHUB_STEP_SUMMARY
          echo "Tests executed from tests/ directory" >> $GITHUB_STEP_SUMMARY
